<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manvik & Aadya | Our Timer</title>
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <link rel="icon" type="image/png" href="https://cdnjs.cloudflare.com/ajax/libs/twemoji/14.0.2/72x72/1f497.png">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-top: #2d0a1a; --bg-bottom: #0f0508; --grid-color: rgba(255, 105, 180, 0.2);
            --accent-pink: #ff85a2; --online-green: #00ff88;
        }

        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, var(--bg-top), var(--bg-bottom)); color: white; font-family: 'Outfit', sans-serif; overflow: hidden; display: flex; justify-content: center; align-items: center; cursor: default; }

        /* Grid Background */
        .grid-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; perspective: 800px; }
        .grid-plane { position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; background-image: linear-gradient(var(--grid-color) 1.5px, transparent 1.5px), linear-gradient(90deg, var(--grid-color) 1.5px, transparent 1.5px); background-size: 60px 60px; transform: rotateX(70deg); animation: moveGrid 8s linear infinite; }
        @keyframes moveGrid { 0% { transform: rotateX(70deg) translateY(0); } 100% { transform: rotateX(70deg) translateY(60px); } }

        /* Branding & Timer */
        .content { text-align: center; z-index: 10; }
        .names { font-size: 3.5rem; font-weight: 600; letter-spacing: 2px; margin: 0; color: #fff; text-shadow: 0 0 20px rgba(255, 133, 162, 0.5); }
        .tagline { font-size: 1rem; color: var(--accent-pink); letter-spacing: 4px; text-transform: uppercase; margin-bottom: 40px; display: block; opacity: 0.8; }
        #timer { display: flex; align-items: center; justify-content: center; gap: 15px; background: rgba(255, 255, 255, 0.03); padding: 30px 50px; border-radius: 100px; border: 1px solid rgba(255, 133, 162, 0.2); backdrop-filter: blur(10px); }
        .unit { display: flex; flex-direction: column; align-items: center; min-width: 90px; }
        .num { font-size: 4rem; font-weight: 300; line-height: 1; }
        .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--accent-pink); margin-top: 8px; }
        .colon { font-size: 3rem; color: var(--accent-pink); opacity: 0.5; padding-bottom: 25px; }

        .status-dot { position: fixed; top: 25px; right: 25px; width: 12px; height: 12px; background: var(--online-green); border-radius: 50%; box-shadow: 0 0 15px var(--online-green); opacity: 0; transition: 0.8s; z-index: 100; }
        .status-dot.active { opacity: 1; }

        /* Aesthetic Music UI */
        #music-trigger { 
            position: fixed; top: 20px; left: 20px; font-size: 1.5rem; cursor: pointer; 
            z-index: 2000; background: rgba(255,133,162,0.15); padding: 12px; border-radius: 50%; 
            border: 1px solid var(--accent-pink); display: none; 
            box-shadow: 0 0 15px rgba(255, 133, 162, 0.3);
            animation: pulseMusic 2s infinite ease-in-out;
        }
        @keyframes pulseMusic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        #music-panel { 
            position: fixed; top: 85px; left: 20px; width: 320px; 
            background: rgba(25, 10, 15, 0.92); border: 1px solid rgba(255, 133, 162, 0.4); 
            border-radius: 25px; padding: 25px; backdrop-filter: blur(25px); 
            z-index: 2001; display: none; box-shadow: 0 20px 50px rgba(0,0,0,0.9); 
        }
        #music-panel input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--accent-pink); border-radius: 12px; color: white; padding: 12px; box-sizing: border-box; margin-bottom: 20px; outline: none; font-family: 'Outfit'; }
        
        .m-btn { background: var(--accent-pink); color: black; border: none; padding: 12px; border-radius: 12px; font-weight: 600; cursor: pointer; flex: 1; font-family: 'Outfit'; transition: 0.2s; }
        .m-btn:hover { background: white; transform: translateY(-2px); }
        .m-btn.end { background: transparent; border: 1px solid #ff4d4d; color: #ff4d4d; margin-left: 10px; }
        .m-btn.end:hover { background: #ff4d4d; color: white; }
        
        #player-container { width: 100%; height: 180px; background: #000; border-radius: 15px; margin-top: 15px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        
        /* Center Centered Overlay */
        #unlock-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 5; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; text-align: center; font-size: 0.85rem; font-weight: 600; 
            color: var(--accent-pink); padding: 20px; box-sizing: border-box;
        }

        #typing-indicator { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); font-size: 0.85rem; color: var(--accent-pink); opacity: 0; transition: 0.3s; font-style: italic; pointer-events: none; }
        #input-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); border: 1px solid var(--accent-pink); padding: 12px 25px; border-radius: 35px; color: white; font-family: 'Outfit'; outline: none; width: 260px; text-align: center; transition: 0.4s; z-index: 1001; backdrop-filter: blur(5px); }
        #input-box:focus { width: 380px; }

        .heart { position: fixed; user-select: none; pointer-events: none; z-index: 999; animation: floatUp 2s ease-out forwards; }
        .floating-message { position: fixed; padding: 14px 30px; background: rgba(255, 133, 162, 0.2); backdrop-filter: blur(10px); border: 1px solid var(--accent-pink); border-radius: 50px; color: white; z-index: 998; animation: messageFade 4s ease-out forwards; white-space: nowrap; font-weight: 600; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-180px) scale(1.6) rotate(20deg); opacity: 0; } }
        @keyframes messageFade { 0% { transform: scale(0.8); opacity: 0; } 10% { transform: scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: translateY(-60px); opacity: 0; } }

        @media (max-width: 600px) { .names { font-size: 2.2rem; } .num { font-size: 2.2rem; } #timer { padding: 25px; gap: 8px; border-radius: 35px;} .unit { min-width: 55px; } .status-dot { top: 15px; right: 15px; } }
    </style>
</head>
<body id="body" onclick="sendHeart(event)">

    <div id="music-trigger" onclick="toggleMusicPanel()">üéµ</div>
    <div id="music-panel">
        <div style="font-size: 1rem; margin-bottom: 15px; font-weight: 600; text-align: center; color: var(--accent-pink);">Shared Session</div>
        <input type="text" id="stream-url" placeholder="Paste YouTube URL / Enter Song Name...">
        <div style="display: flex;">
            <button class="m-btn" onclick="startStream()">Stream</button>
            <button class="m-btn end" onclick="terminateSession()">End Session</button>
        </div>
        <div id="player-container">
            <div id="unlock-overlay" onclick="unlockAudio()">üîä Tap to Join Music</div>
            <div id="yt-player"></div>
        </div>
        <div id="song-info" style="font-size: 0.75rem; margin-top: 15px; color: var(--accent-pink); text-align: center; opacity: 0.6;">Search results will play automatically.</div>
    </div>

    <div class="grid-container"><div class="grid-plane"></div></div>
    <div id="status-dot" class="status-dot"></div>

    <div class="content">
        <h1 class="names">Manvik & Aadya</h1>
        <span class="tagline">Syncing Seconds, Shaping Forever</span>
        <div id="timer">
            <div class="unit"><div class="num" id="d">00</div><div class="label">Days</div></div>
            <div class="colon">:</div>
            <div class="unit"><div class="num" id="h">00</div><div class="label">Hours</div></div>
            <div class="colon">:</div>
            <div class="unit"><div class="num" id="m">00</div><div class="label">Mins</div></div>
            <div class="colon">:</div>
            <div class="unit"><div class="num" id="s">00</div><div class="label">Secs</div></div>
        </div>
        <p style="margin-top: 35px; opacity: 0.5; font-size: 0.85rem; letter-spacing: 1px;">When one clicks, both see the love ‚ù§Ô∏è</p>
    </div>

    <div id="typing-indicator">Your partner is typing...</div>
    <input type="text" id="input-box" placeholder="Send a message..." onclick="event.stopPropagation()">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDU7hORkNs0SauYUi_3xLuFUSA01gRvE1o",
            authDomain: "manviktimer.firebaseapp.com",
            databaseURL: "https://manviktimer-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "manviktimer",
            storageBucket: "manviktimer.firebasestorage.app",
            messagingSenderId: "214181977928",
            appId: "1:214181977928:web:73a69a161391a994eb1d7d",
            measurementId: "G-Q3XQ4056BV"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const startTime = new Date(2024, 5, 21, 14, 26, 27);

        // --- MUSIC ENGINE ---
        let player;
        let isUnlocked = false;
        let currentId = "";

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '180', width: '320',
                playerVars: { 'autoplay': 1, 'controls': 1, 'origin': window.location.origin, 'enablejsapi': 1 },
                events: { 'onReady': onPlayerInit, 'onStateChange': onPlayerStateChange }
            });
        }

        function calculateSyncTime(data) {
            return data.time + ((Date.now() - data.timestamp) / 1000);
        }

        function onPlayerInit() {
            db.ref('music_active').on('value', (s) => {
                const active = s.val();
                const trigger = document.getElementById('music-trigger');
                if (active) trigger.style.display = 'block';
                else {
                    trigger.style.display = 'none';
                    document.getElementById('music-panel').style.display = 'none';
                    if (player) player.stopVideo();
                    currentId = "";
                }
            });

            db.ref('stream').on('value', (snap) => {
                const data = snap.val();
                if (!data) return;

                if (data.type === 'id') {
                    if (data.videoId !== currentId) {
                        player.loadVideoById({ videoId: data.videoId, startSeconds: calculateSyncTime(data) });
                        currentId = data.videoId;
                    }
                } else if (data.type === 'search') {
                    if (data.query !== currentId) {
                        player.loadPlaylist({ list: data.query, listType: 'search' });
                        currentId = data.query;
                    }
                }

                if (data.state === 'playing') {
                    if (isUnlocked) player.playVideo();
                } else { player.pauseVideo(); }
            });
        }

        function onPlayerStateChange(event) {
            if (!isUnlocked) return;
            if (event.data === YT.PlayerState.PAUSED) {
                db.ref('stream').update({ state: 'paused', time: player.getCurrentTime(), timestamp: Date.now() });
            } else if (event.data === YT.PlayerState.PLAYING) {
                db.ref('stream').update({ state: 'playing', time: player.getCurrentTime(), timestamp: Date.now() });
            }
        }

        function unlockAudio() {
            isUnlocked = true;
            document.getElementById('unlock-overlay').style.display = "none";
            db.ref('stream').once('value', (s) => {
                const d = s.val();
                if (d && d.state === 'playing') player.playVideo();
            });
        }

        function toggleMusicPanel() { 
            const p = document.getElementById('music-panel');
            p.style.display = (p.style.display === "block") ? "none" : "block";
        }

        function startStream() {
            const val = document.getElementById('stream-url').value.trim();
            if (!val) return;

            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = val.match(regExp);
            const id = (match && match[2].length === 11) ? match[2] : null;

            if (id) {
                db.ref('stream').set({ type: 'id', videoId: id, state: 'playing', time: 0, timestamp: Date.now() });
            } else {
                // Song search
                db.ref('stream').set({ type: 'search', query: val, state: 'playing', time: 0, timestamp: Date.now() });
            }
            
            document.getElementById('stream-url').value = "";
            if (!isUnlocked) unlockAudio();
        }

        function terminateSession() {
            db.ref('stream').remove();
            db.ref('music_active').set(false);
        }

        // --- UI & TYPING ENGINE ---
        const input = document.getElementById('input-box');
        const typingIndicator = document.getElementById('typing-indicator');
        const myTypingRef = db.ref('typing').push();
        myTypingRef.onDisconnect().remove();

        input.addEventListener('input', () => {
            if (input.value.trim().length > 0) myTypingRef.set({ active: true, time: Date.now() });
            else myTypingRef.remove();
        });

        db.ref('typing').on('value', (snap) => {
            let active = false;
            const now = Date.now();
            snap.forEach((c) => {
                const data = c.val();
                if (c.key !== myTypingRef.key && data.active && (now - data.time < 6000)) active = true;
            });
            typingIndicator.style.opacity = active ? "1" : "0";
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && input.value.trim() !== "") {
                const raw = input.value.trim();
                const cmd = raw.toLowerCase();
                myTypingRef.remove();
                if (cmd === "/music") { db.ref('music_active').set(true); input.value = ""; return; }
                let msg = raw;
                if (cmd.includes("time together")) {
                    const now = new Date();
                    let y = now.getFullYear() - startTime.getFullYear();
                    let m = now.getMonth() - startTime.getMonth();
                    let d = now.getDate() - startTime.getDate();
                    if (d < 0) { m--; d += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
                    if (m < 0) { y--; m += 12; }
                    msg = `‚ú® ${y}y ${m}mo ${d}d ${now.getHours().toString().padStart(2,'0')}h ${now.getMinutes().toString().padStart(2,'0')}m ${now.getSeconds().toString().padStart(2,'0')}s ‚ú®`;
                }
                if (cmd.includes("love")) db.ref('actions').push({ type: 'confetti', timestamp: Date.now() });
                db.ref('messages').push({ text: msg, x: Math.random() * 0.6 + 0.2, y: Math.random() * 0.4 + 0.3, timestamp: Date.now() });
                input.value = "";
            }
        });

        const myPresence = db.ref('presence').push();
        myPresence.set(true); myPresence.onDisconnect().remove();
        db.ref('presence').on('value', s => document.getElementById('status-dot').classList.toggle('active', s.numChildren() > 1));

        function tick() {
            const diff = new Date() - startTime;
            document.getElementById('d').innerText = Math.floor(diff / 86400000).toString().padStart(2, '0');
            document.getElementById('h').innerText = Math.floor((diff / 3600000) % 24).toString().padStart(2, '0');
            document.getElementById('m').innerText = Math.floor((diff / 60000) % 60).toString().padStart(2, '0');
            document.getElementById('s').innerText = Math.floor((diff / 1000) % 60).toString().padStart(2, '0');
        }
        setInterval(tick, 1000); tick();

        function sendHeart(e) {
            db.ref('hearts').push({ x: e.clientX/window.innerWidth, y: e.clientY/window.innerHeight, icon: ['üíñ','‚ù§Ô∏è','üíù','üíó','üíì','üíò'][Math.floor(Math.random()*6)], timestamp: Date.now() });
        }
        db.ref('hearts').on('child_added', s => {
            const d = s.val(); if (Date.now()-d.timestamp > 2000) return;
            const h = document.createElement('div'); h.className='heart'; h.innerHTML=d.icon;
            h.style.left=d.x*100+'%'; h.style.top=d.y*100+'%'; document.body.appendChild(h); setTimeout(()=>h.remove(), 2000);
        });
        db.ref('messages').on('child_added', s => {
            const d = s.val(); if (Date.now()-d.timestamp > 4000) return;
            const m = document.createElement('div'); m.className='floating-message'; m.innerText=d.text;
            m.style.left=d.x*100+'%'; m.style.top=d.y*100+'%'; document.body.appendChild(m); setTimeout(()=>m.remove(), 4000);
        });
        db.ref('actions').on('child_added', s => {
            if (s.val().type==='confetti' && Date.now()-s.val().timestamp < 3000) confetti({ origin:{y:0.7}, particleCount:150, spread:70, colors:['#ff85a2','#fff'] });
        });

        setInterval(() => {
            const old = Date.now() - 10000;
            ['hearts', 'messages', 'actions'].forEach(p => db.ref(p).orderByChild('timestamp').endAt(old).once('value', s => s.forEach(c => c.ref.remove())));
        }, 20000);
    </script>
</body>
</html>